<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡å–®æ¨¡å¼ï¼šå–®å­—è§£è¬</title>
    <link rel="stylesheet" href="/static/easy_mode.css">
</head>
<body>
    <audio id="easy-bgm" src="/static/music_easy.mp3" loop autoplay></audio>

    <div class="bg-layer"></div>
    <a href="/" alt="go-back">
        <button id="back-btn" class="back-btn">å›ä¸Šé </button>
    </a>

    <div id="level-indicator">
        <div class="level-circle active">1</div>
        <div class="level-circle">2</div>
        <div class="level-circle">3</div>
        <div class="level-circle">4</div>
        <div class="level-circle">5</div>
        <div class="level-circle">6</div>
        <div class="level-circle">7</div>
        <div class="level-circle">8</div>
        <div class="level-circle">9</div>
        <div class="level-circle">10</div>
        <div class="level-circle">11</div>
        <div class="level-circle">12</div>
    </div>

    <div id="stars-container">
        <span class="star word-star">â˜…</span>
        <span class="star word-star">â˜…</span>
        <span class="star word-star">â˜…</span>
        <span class="star sentence-star">â˜…</span>
        <span class="star sentence-star">â˜…</span>
        <span class="star sentence-star">â˜…</span>
        <span class="star sentence-star">â˜…</span>

        <div id="scoring-standards" class="scoring-standards">
            <h4>å¦‚ä½•ç²å¾—æ›´å¤šæ˜Ÿæ˜Ÿ?</h4>
            <ul>
                <li>â­ å¥å­ç¬¦åˆé¡Œç›®æ–‡æ³•æç¤ºè¦æ±‚</li>
                <li>â­ å¥å­ä½¿ç”¨äº†æ­£ç¢ºå–®å­—</li>
                <li>â­ æ²’æœ‰åŸºæœ¬æ–‡æ³•ã€æ‹¼å¯«å•é¡Œä¸”ç©ºæ ¼ä½¿ç”¨æ­£ç¢º</li>
                <li>â­ å¥å­è¡¨é”æµæš¢ï¼Œé”ä¸€å®šè¤‡é›œåº¦</li>  
            </ul>
        </div>
    </div>

    <div id="game-box" class="game-box">
        <div id="left-side">
            <img id="vague-image" src="" alt="vague-image">
            <p>çŒœçŒœçœ‹åœ–ç‰‡ä¸­æœ‰ä»€éº¼ï¼Ÿ</p>
        </div>
        <div id="right-side">
            <div id="tip-boxes">
                <div class="tip-box" id="tip1"></div>
                <div class="tip-box" id="tip2"></div>
                <div class="tip-box" id="tip3"></div>
            </div>
            <div id="answer-boxes">
                <div class="answer-box" id="answer1"></div>
                <div class="answer-box" id="answer2"></div>
                <div class="answer-box" id="answer3"></div>
            </div>
        </div>
    </div>

    <div class="sentence" id="sentence">
        <p>è«‹ç”¨é¸æ“‡çš„ä¸‰å€‹å–®å­—é€ ä¸€å€‹å¥å­</p>
        <input type="text" id="sentence-input" placeholder="åœ¨é€™è£¡è¼¸å…¥æ‚¨çš„è‹±æ–‡å¥å­..." class="sentence-input">
        <button class="confirm-btn hidden">ç¢ºèª</button>
    </div>

    <div id="answer-area" class="answer-area">
        <div class="word-card">
            <div class="cards"></div>
            <button class="submit-btn hidden">æª¢æŸ¥ç­”æ¡ˆ</button>
        </div> 
        <div class="feed-back">
            <div id="feedback-container"></div>
        </div> 
    </div>

    <div id="image-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-body">
                <div class="modal-body-flex">
                    <div class="image-column">
                        <h3>é—œå¡åŸå§‹åœ–ç‰‡ï¼š</h3>
                        <img id="generated-image" src="" alt="Original Image">
                    </div>
                    <div class="image-column">
                        <h3>æ‚¨ç”¨å¥å­ç”Ÿæˆçš„åœ–ç‰‡å¦‚ä¸‹ï¼š</h3>
                        <div id="ai-loading-placeholder">åœ–ç‰‡ç”Ÿæˆä¸­...</div>
                        <img id="ai-generated-image" src="" alt="AI Generated Image" class="hidden">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="next-level-btn">ä¸‹ä¸€é—œ</button>
            </div>
        </div>
    </div>

    <script>
        let currentLevel = 1; 
        let levelDataCache = []; 
        let currentSentencePrompt = ""; 
        let feedbackCount = 0; // æ–°å¢ï¼šè¿½è¹¤ AI å›é¥‹æ¬¡æ•¸

        const words = [
            "universe","crocodile","jellyfish","farm","cow","chicken","turtle","umbrella","raining",
            "pigeon","penguin","fence","waterfall","elephant","bird","bunny","desert","wolf","rock",
            "zebra","lion","boat","ocean","whale","cat","moon","night","koala","ice","grass","puppy",
            "parrot","forest","snow","rose","duck","tiger","horse","goose","mountain","dessert","fish"
        ];
        function updateStars(type, count) {
            const selector = type === 'word' ? '.word-star' : '.sentence-star';
            const starGroup = document.querySelectorAll(selector);
            starGroup.forEach((star, index) => {
                if (index < count) {
                    star.classList.add('lit');
                } else {
                    star.classList.remove('lit');
                }
            });
        }
        
        function typeEffect(elementId, text, delay = 30, callback = null) {
            const container = document.getElementById(elementId);
            container.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
            
            // å‰µå»ºä¸€å€‹ç”¨ä¾†é¡¯ç¤ºæ–‡å­—çš„ element
            const outputElement = document.createElement('div');
            // é‡è¦ï¼šé€™è¡Œè®“ \n è®ŠæˆçœŸæ­£çš„æ›è¡Œ
            outputElement.style.whiteSpace = 'pre-wrap'; 
            outputElement.style.lineHeight = '1.6'; // è®“è¡Œè·ç¾è§€ä¸€é»
            container.appendChild(outputElement);
            
            let i = 0;
            const feedBackBox = document.querySelector(".feed-back"); 
            
            function typing() {
                if (i < text.length) {
                    // çµ±ä¸€ä½¿ç”¨ textContentï¼Œé€™æ¨£æœ€å®‰å…¨ï¼Œä¹Ÿä¸æœƒèª¤è§£ææ¨™ç±¤
                    outputElement.textContent += text.charAt(i);
                    i++;
                    
                    // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
                    if(feedBackBox) feedBackBox.scrollTop = feedBackBox.scrollHeight;
                    
                    setTimeout(typing, delay);
                } else if (callback) { 
                    callback(); 
                }
            }
            typing();
        }

        async function showModal() {
            const levelData = levelDataCache.find(item => item.level === currentLevel);
            const userSentence = document.getElementById("sentence-input").value.trim();
            
            const selectedWords = [
                document.getElementById("answer1").textContent.trim(),
                document.getElementById("answer2").textContent.trim(),
                document.getElementById("answer3").textContent.trim()
            ];

            // --- [ä¿®æ­£é‡é»]ï¼šæŠ“å–ç”Ÿåœ–ç•¶ä¸‹çš„æ˜Ÿæ˜Ÿç¸½æ•¸ ---
            const currentWordStars = document.querySelectorAll('.word-star.lit').length;
            const currentSentenceStars = document.querySelectorAll('.sentence-star.lit').length;

            document.getElementById("generated-image").src = levelData ? levelData.image_origin : "";
            const loading = document.getElementById("ai-loading-placeholder");
            const aiImg = document.getElementById("ai-generated-image");
            
            loading.classList.remove("hidden");
            loading.textContent = "æ­£åœ¨ç”Ÿæˆåœ–ç‰‡ä¸¦ä¿å­˜ç´€éŒ„..."; 
            aiImg.classList.add("hidden");
            document.getElementById("image-modal").classList.add("visible");

            try {
                const response = await fetch("/api/generate_image", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_sentence: userSentence,
                        level: currentLevel,
                        correct_words: selectedWords,
                        word_stars: currentWordStars,
                        sentence_stars: currentSentenceStars
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const result = await response.json();
                const imgSource = result.image_data;

                if (imgSource) {
                    aiImg.src = `data:image/png;base64,${imgSource}`;
                    loading.classList.add("hidden");
                    aiImg.classList.remove("hidden");
                } else {
                    loading.textContent = "åœ–ç‰‡ç”Ÿæˆå¤±æ•—ã€‚";
                }
            } catch (e) {
                loading.textContent = "ç”Ÿåœ–é€£ç·šç•°å¸¸ã€‚";
            }
        }

        function loadLevel(level, isReplay = false) {
            if (level > levelDataCache.length) { level = 1; }
            if (level < 1) { level = 1; }
            const levelData = levelDataCache.find(item => item.level === level);
            if (!levelData) return;
            
            currentLevel = level;
            feedbackCount = 0; // é‡ç½®å›é¥‹æ¬¡æ•¸
            
            document.querySelectorAll(".level-circle").forEach(c => {
                c.classList.remove("active");
                if (parseInt(c.textContent) === level) c.classList.add("active");
            });

            document.getElementById("vague-image").src = levelData.image_vague;
            document.getElementById("tip1").textContent = levelData.tip[0];
            document.getElementById("tip2").textContent = levelData.tip[1];
            document.getElementById("tip3").textContent = levelData.tip[2];

            if (!isReplay) {
                document.querySelectorAll(".answer-box").forEach(b => { 
                    b.textContent = ""; 
                    b.classList.remove("incorrect", "correct", "correct-locked"); 
                });
                document.getElementById("sentence-input").value = "";
                document.getElementById("feedback-container").innerHTML = "";
                const confirmBtn = document.querySelector(".confirm-btn");
                confirmBtn.textContent = "ç¢ºèª"; // é‡ç½®æŒ‰éˆ•æ–‡å­—
                renderCards(); 
                setSentencePrompt(levelData);
            }
            updateConfirmButton();
            document.querySelectorAll(".star").forEach(s => s.classList.remove("lit"));
        }

        function renderCards() {
            const container = document.querySelector(".cards");
            const taken = Array.from(document.querySelectorAll(".answer-box")).map(b => b.textContent.trim()).filter(w => w !== "");
            container.innerHTML = "";
            [...words].sort().forEach(word => {
                if (taken.includes(word)) return;
                const card = document.createElement("div");
                card.className = "card";
                card.textContent = word;
                card.dataset.word = word;
                container.appendChild(card);
            });
        }

        function setSentencePrompt(levelData) {
            const p = document.querySelector("#sentence p");
            if (levelData?.sentence?.length > 0) {
                currentSentencePrompt = levelData.sentence[Math.floor(Math.random() * levelData.sentence.length)];
                p.innerHTML = `è«‹ç”¨é¸æ“‡çš„ä¸‰å€‹å–®å­—é€ ä¸€å€‹å¥å­ (${currentSentencePrompt})`;
            }
        }

        function updateConfirmButton() {
            const a1 = document.getElementById("answer1").textContent.trim();
            const a2 = document.getElementById("answer2").textContent.trim();
            const a3 = document.getElementById("answer3").textContent.trim();
            const s = document.getElementById("sentence-input").value.trim();
            
            const isCardsFull = (a1 !== "" && a2 !== "" && a3 !== "");
            document.querySelector(".submit-btn").classList.toggle("hidden", !isCardsFull);

            const isSentenceReady = (s !== "");
            document.querySelector(".confirm-btn").classList.toggle("hidden", !isSentenceReady);
            // ç§»é™¤èˆŠ generate-image-btn çš„é¡¯ç¤ºé€»è¾‘
        }

        function handleSubmitAnswer() {
            const levelData = levelDataCache.find(item => item.level === currentLevel);
            if (!levelData) return;
            const userBoxes = [document.getElementById("answer1"), document.getElementById("answer2"), document.getElementById("answer3")];
            const corrects = levelData.answer.map(w => w.toLowerCase());

            userBoxes.forEach(box => {
                const word = box.textContent.trim().toLowerCase();
                box.classList.remove("incorrect", "correct", "correct-locked");
                if (corrects.includes(word)) {
                    box.classList.add("correct", "correct-locked"); 
                } else if (word !== "") {
                    box.classList.add("incorrect"); 
                }
            });
            const correctCount = document.querySelectorAll(".answer-box.correct").length;
            updateStars('word', correctCount);
        }
        function evaluateSentenceStars(sentence, userWords) {
            let stars = 0;
            const s = sentence.trim();
            const sLower = s.toLowerCase();
            
            // --- æº–å‚™æª¢æ¸¬å·¥å…· ---
            // 1. å¥å‹é–€æª»æª¢æ¸¬ (ç¬¦åˆ These are... æˆ– What is... doing?)
            const hasPattern = /\b(these|those|they are)\b/i.test(sLower) || /\bwhat (is|are) .+ doing\b/i.test(sLower);
            
            // 2. å–®å­—æ‡‰ç”¨æª¢æ¸¬ (åŒ…å«è‡³å°‘ 3 å€‹é¸æ“‡çš„å–®å­—)
            const usedCount = userWords.filter(w => sLower.includes(w.toLowerCase())).length;
            
            // 3. æ ¼å¼èˆ‡åŸºç¤æ–‡æ³•æª¢æ¸¬
            const hasSubject = /\b(i|you|he|she|it|we|they|the|this|that|these|those)\b/i.test(sLower);
            const hasVerb = /\b(is|am|are|was|were|be|have|has|do|does|did|can|could|will|should)\b/i.test(sLower);
            const properFormat = /^[A-Z]/.test(s) && /[.!?]$/.test(s); // é¦–å­—å¤§å¯«ä¸”æ¨™é»çµå°¾
            const noSpacingIssue = !(/\s[.,!?;:]|[.,!?;:](?!\s|$)|\s{2,}/.test(s)); // æ¨™é»ç©ºæ ¼æ­£ç¢º
            
            // 4. é€²éšè±å¯Œåº¦
            const wordCount = s.split(/\s+/).filter(w => w.length > 0).length;
            const hasAdjective = /\b(beautiful|big|small|happy|sad|red|blue|green|yellow|white|black|fast|slow|good|nice)\b/i.test(sLower);

            // --- éšå±¤å¼çµ¦æ˜Ÿ (1-4 é¡†é€ å¥æ˜Ÿ) ---
            
            // â­ ç¬¬ 1 é¡†é€ å¥æ˜Ÿ (ç¸½è¨ˆç¬¬ 4 é¡†)ï¼šå¿…é ˆç¬¦åˆå¥å‹æç¤º
            if (hasPattern) {
                stars = 1;

                // â­ ç¬¬ 2 é¡†é€ å¥æ˜Ÿ (ç¸½è¨ˆç¬¬ 5 é¡†)ï¼šå¿…é ˆç¬¦åˆå¥å‹ + ç”¨å° 3 å€‹å–®å­—
                if (usedCount >= 3) {
                    stars = 2;

                    // â­ ç¬¬ 3 é¡†é€ å¥æ˜Ÿ (ç¸½è¨ˆç¬¬ 6 é¡†)ï¼šæ ¼å¼æ­£ç¢º + æœ‰ä¸»è¬‚ + ç„¡ç©ºæ ¼éŒ¯èª¤
                    if (properFormat && hasSubject && hasVerb && noSpacingIssue) {
                        stars = 3;

                        // â­ ç¬¬ 4 é¡†é€ å¥æ˜Ÿ (ç¸½è¨ˆç¬¬ 7 é¡†)ï¼šå¥å­é•·åº¦ >= 6 ä¸”æœ‰å½¢å®¹è© (æµæš¢åº¦çå‹µ)
                        if (wordCount >= 6 && hasAdjective) {
                            stars = 4;
                        }
                    }
                }
            }

            updateStars('sentence', stars);
        }

        async function handleConfirm() {
            const btn = document.querySelector(".confirm-btn");
            const sentenceInput = document.getElementById("sentence-input");
            const levelData = levelDataCache.find(item => item.level === currentLevel);
            
            if (!levelData) return;

            const userBoxes = [document.getElementById("answer1"), document.getElementById("answer2"), document.getElementById("answer3")];
            const userWords = userBoxes.map(b => b.textContent.trim().toLowerCase()).filter(w => w !== "");
            
            // --- [ä¿®æ­£é‡é» 1]ï¼šå…ˆè¨ˆç®—æ˜Ÿæ˜Ÿï¼Œæ›´æ–°ç•«é¢ä¸Š class "lit" çš„ç‹€æ…‹ ---
            evaluateSentenceStars(sentenceInput.value.trim(), userWords);

            // --- [ä¿®æ­£é‡é» 2]ï¼šå¾æ›´æ–°å¾Œçš„ç•«é¢æŠ“å–æ­£ç¢ºçš„æ˜Ÿæ˜Ÿæ•¸ ---
            const currentWordStars = document.querySelectorAll('.word-star.lit').length;
            const currentSentenceStars = document.querySelectorAll('.sentence-star.lit').length;

            if (feedbackCount >= 3) {
                showModal();
                return;
            }

            const corrects = levelData.answer.map(w => w.toLowerCase());
            const missing = corrects.filter(w => !userWords.includes(w));
            
            btn.disabled = true;
            document.getElementById("feedback-container").innerHTML = "ğŸ¤– AI è€å¸«æ­£åœ¨é–±å·ä¸¦è¨˜éŒ„å­¸ç¿’é€²åº¦...";

            try {
                const res = await fetch("/api/ai_feedback", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        level: currentLevel, 
                        missing_words: missing, 
                        user_sentence: sentenceInput.value.trim(), 
                        sentence_prompt: currentSentencePrompt, 
                        correct_words: userWords,
                        feedback_count: feedbackCount,
                        // å‚³é€å‰›æ‰è¨ˆç®—å¥½çš„æ˜Ÿæ˜Ÿæ•¸
                        word_stars: currentWordStars,
                        sentence_stars: currentSentenceStars
                    })
                });
                
                const data = await res.json();
                
                typeEffect('feedback-container', data.feedback, 30, () => {
                    feedbackCount++; 
                    btn.disabled = false;
                    if (feedbackCount < 3) {
                        btn.textContent = "å†é€ ä¸€æ¬¡";
                    } else {
                        btn.textContent = "ç”Ÿæˆåœ–ç‰‡";
                    }
                    updateConfirmButton();
                });
            } catch (e) {
                document.getElementById("feedback-container").innerHTML = "é€£ç·šå¤±æ•—ã€‚";
                btn.disabled = false;
            }
        }
        
        window.addEventListener("DOMContentLoaded", () => {
            document.querySelector(".cards").addEventListener("click", e => {
                if (!e.target.classList.contains("card")) return;
                const emptyBox = [
                    document.getElementById("answer1"),
                    document.getElementById("answer2"),
                    document.getElementById("answer3")
                ].find(b => b.textContent.trim() === "");
                
                if (emptyBox) {
                    emptyBox.textContent = e.target.dataset.word; 
                    e.target.remove(); 
                    updateConfirmButton(); 
                }
            });

            document.querySelectorAll(".answer-box").forEach(box => {
                box.addEventListener("click", () => {
                    if (box.textContent === "" || box.classList.contains("correct-locked")) return;
                    box.textContent = ""; 
                    box.classList.remove("incorrect", "correct");
                    renderCards(); 
                    updateConfirmButton();
                });
            });

            document.getElementById("sentence-input").addEventListener("input", () => {
                // ä¿®æ”¹å¥å­æ™‚ï¼Œä¸éœ€è¦é‡ç½®å›é¥‹æ¬¡æ•¸ï¼Œåªéœ€ç¢ºèªæŒ‰éˆ•æ˜¯å¦é¡¯ç¤º
                updateConfirmButton();
            });

            document.querySelector(".confirm-btn").addEventListener("click", handleConfirm);
            document.querySelector(".submit-btn").addEventListener("click", handleSubmitAnswer); 
            
            // ç§»é™¤èˆŠ generate-image-btn çš„äº‹ä»¶ç›£è½

            document.getElementById("next-level-btn").addEventListener("click", () => { 
                document.getElementById("image-modal").classList.remove("visible"); 
                loadLevel(currentLevel + 1); 
            });
            
            fetch("/static/data/easy_mode.json")
                .then(res => res.json())
                .then(data => { 
                    levelDataCache = data; 
                    const urlParams = new URLSearchParams(window.location.search);
                    const levelParam = urlParams.get('level');
                    loadLevel(levelParam ? parseInt(levelParam) : 1);
                });
        });
    </script>
</body>
</html>